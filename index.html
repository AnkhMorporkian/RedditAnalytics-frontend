<html>
  <head>
    <title>rednit</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/0.4.10/themes/pace-theme-minimal.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/pace/0.4.10/pace.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">
    <style type='text/css'>
      .navbar-inverse {
        background-image: linear-gradient(to bottom,#8D0000 0,#F00 100%);
      }
      .navbar-inverse .navbar-nav>li>a,
      .navbar-inverse .navbar-brand {
        color: white;
      }

      .sidebar {
        margin-top: 1em;
        background: #666677 url('/images/blue-linen.jpg');
        color: white;
        font-size: 80%;
        width: 300px;
        border-radius: 1em;
      }
      .sidebar table {
        font-size: 100%;
        color: white;
      }

      .sidebar a {
        color: #BBB;
      }

      .sidebar h1 {
        font-size: 150%;
      }
      .sidebar h2 {
        font-size: 140%;
      }
      .sidebar h3 {
        font-size: 130%;
      }
      .sidebar h4 {
        font-size: 120%;
      }
      .sidebar h5 {
        font-size: 110%;
      }
      .sidebar h6 {
        font-size: 100%;
      }

      .ups, .downs, .score {
        text-align: right;
        width: 4em;
      }
      .ups {
        color: green;
      }
      .downs {
        color: red;
      }
      .submission .score {
        font-weight: bold;
      }
      .ups:before {
        content: '+';
      }
      .downs:before {
        content: '-';
      }
      .submission-list > .submission {
        padding: 1em;
        margin: 0 0 0 0;
      }
      .submission-list > .submission:nth-child(even) {
        background-color: #EEEEEE;
      }
      body {
        background: url('/images/white-linen.jpg');
      }
      article.container {
        background-color: rgba(255, 255, 255, 0.5);
        padding-top: 50px;
        padding-bottom: 25px;
      }

      article.container,
      .navbar .container {
        width: 100%;
      }

      ul.comments {
        list-style-type: none;
        padding-left: 1em;
      }

      ul.comments li.comment {
        border-left: 1px solid #eeeeee;
        padding-left: 1em;
      }

      .comment .meta,
      .comment .body,
      .comment .buttons {
      }

      .submission .domain,
      .comment .meta {
        color: #666;
      }

      .comment .meta a {
        font-weight: bold;
      }

      a {
        color: #369;
        color: #8D0000;
      }

      .submission .media-heading {
        font-size: 120%;
      }

      .stickied .media-heading a {
        font-weight: bold;
        color: green;
      }

      .comment .buttons a {
        color: #666;
        font-weight: bold;
        margin-top: 0;
        padding-top: 1em;
        margin-right: 0.5em;
      }

      .has-multiple-posts .selftext {
        display: none;
      }
    </style>
  </head>
  <body>
    <script type="text/x-handlebars">
      <div class='navbar navbar-inverse navbar-fixed-top'>
        <div class='navbar-inner'>
          <div class='container'>
            {{#linkTo "reddit" "r/redditanalytics" class="navbar-brand"}}rednit{{/linkTo}}
            <div class='navbar-collapse collapse'>
              <ul class='nav navbar-nav'>
                {{#linkTo "reddit" "r/all" tagName="li"}}
                  <a href='#'>/r/all</a>
                {{/linkTo}}
                {{#linkTo "submissions.stream" tagName="li"}}
                  <a href='#'>/new</a>
                {{/linkTo}}
              </ul>
            </div>
          </div>
        </div>
      </div>
      <article class='container'>{{outlet}}</article>
    </script>
    <script type="text/x-handlebars" data-template-name="submissions/stream">
      <div class="input-group">
        <span class="input-group-addon">http://stream.redditanalytics.com/?channel=submissions&amp;</span>
        {{input class="form-control" value=newArgs placeholder="Stream URL arguments" size="128"}}
        {{#linkTo "submissions.stream.custom" newArgs class='input-group-addon'}}
          Change Stream
        {{/linkTo}}
      </div>
      <div class='submission-list'>
      {{#each submissions itemController="submissionItem"}}
        {{partial "submissionItem"}}
      {{else}}
        <div class='waiting media'>
          <div class='media-body'>
            <h4 class='media-heading'>
              Waiting for submissions...
            </h4>
          </div>
        </div>
      {{/each}}
      </div>
    </script>

    <script type="text/x-handlebars" data-template-name="submissionItem">
      <div {{bind-attr class='stickied :submission :media'}}>
          <div class='pull-left votes'>
            <div class='ups'>{{unbound ups}}</div>
            <div class='score'>{{unbound score}}</div>
            <div class='downs'>{{unbound downs}}</div>
          </div>
        {{#if thumbnail}}
          <div class='pull-left'>
            <a href="{{unbound url}}" target="reddit">
              <img class='media-object' src="{{unbound thumbnail}}"/>
            </a>
          </div>
        {{/if}}
        <div class='media-body'>
          <span class='media-heading'><a href="{{unbound url}}" target="reddit">{{{unbound title}}}</a></span>
          {{#linkTo 'reddit' domainPath class='domain'}}({{unbound domain}}){{/linkTo}}
          {{#if link_flair_text}}
            <span class='label label-primary link-flair'>{{unbound link_flair_text}}</span>
          {{/if}}
          <div class='media'>
            {{#if selfText}}
              <section class='well selftext'>
                {{{unbound selfText}}}
              </section>
            {{/if}}
            {{#linkTo 'reddit' permalinkPath class="permalink"}}
              {{#if num_comments}}
                {{unbound num_comments}}
              {{/if}}
              comments
            {{/linkTo}}
            submitted
            <span class='date'>{{created}}</span>
            by
            {{#linkTo 'reddit' authorPath class="author"}}
              {{unbound author}}
              {{#if author_flair_text}}
                <span class='label label-info link-flair'>{{unbound author_flair_text}}</span>
              {{/if}}
            {{/linkTo}}
            to {{#linkTo 'reddit' subredditPath class="subreddit"}}{{unbound subreddit}}{{/linkTo}}
          </div>
        </div>
      </div>
    </script>

    <script type="text/x-handlebars" data-template-name="commentItem">
      <li class='comment'>
        <div class='meta'>
          by
          {{#linkTo 'reddit' authorPath class="author"}}{{unbound author}}
            {{#if author_flair_text}}
              <span class='label label-info link-flair'>{{unbound author_flair_text}}</span>
            {{/if}}
          {{/linkTo}}
          {{#if score_hidden}}
            <span class='score-hidden'>[score hidden]</span>
          {{else}}
            <span class='score'>{{unbound score}} points</span>
          {{/if}}
          <span class='date'>{{unbound created}}</span>
          {{#if gilded}}
            <span class='gilded glyphicon glyphicon-star-empty label label-warning'>{{gilded}}</span>
          {{/if}}
        </div>
        <section class='body'>
          {{{unbound body}}}
        </section><div class='buttons'>
          {{#linkTo 'reddit' permalinkPath class='permalink'}}permalink{{/linkTo}}
          {{#linkTo 'comments.tree' id class="comment-tree-search"}}search{{/linkTo}}
        </div>
        <ul class='comments'>
        {{#each childComments itemController="commentsTree"}}
          {{partial "commentItem"}}
        {{/each}}
        {{#each moreComments}}
          <li class='more'>and {{unbound count}} replies </li>
        {{/each}}
        </ul>
      </li>
    </script>

    <script type="text/x-handlebars" data-template-name="comments/tree">
      <h3>Comment Tree for: {{id}}</h3>
      <ul class='comments'>
        {{partial "commentItem"}}
      </ul>
    </script>

    <script type="text/x-handlebars" data-template-name="reddit">
      <section {{bindAttr class='hasMultiplePosts :reddit'}}>
        {{#if sidebarHtml}}
          <section class='sidebar well pull-right'>
            <h1 class='subreddit-title'>
              {{#linkTo 'reddit' sidebar.subredditPath}}/r/{{sidebar.display_name}}{{/linkTo}}
            </h1>
            {{{sidebarHtml}}}
          </section>
        {{/if}}
        <div class='submission-list'>
        {{#each posts itemController="submissionItem"}}
          {{partial "submissionItem"}}
        {{/each}}
        </div>

        <ul class='comments'>
        {{#each comments itemController="commentsTree"}}
          {{partial "commentItem"}}
        {{/each}}
        </ul>

        <div class='page-nav'>
          {{#if hasMultiplePosts}}
            view more:
            {{#if prevPath}}
              {{#linkTo 'reddit' prevPath class='label label-default'}}&laquo; prev{{/linkTo}}
            {{/if}}
            {{#if nextPath}}
              {{#linkTo 'reddit' nextPath class='label label-default'}}next &raquo;{{/linkTo}}
            {{/if}}
            {{!--
            or try a {{#linkTo 'reddit' 'r/random' class='label label-default'}}random subreddit{{/linkTo}}
            --}}
          {{/if}}
        </div>
      </section>
    </script>

    <script type="text/x-handlebars" data-template-name="loading">
      <h1 class='loading'>{{loadingMessage}}</h1>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.4.0/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/ember.js/1.2.0-beta.4/ember.min.js'></script>
    <script type="text/javascript">
      var App = Ember.Application.create();

      App.htmlDecode = function(value){
        return $('<div/>').html(value).text();
      };

      Ember.Handlebars.registerHelper('html', function(html) {
        return new Handlebars.SafeString(html);
      });

      App.Clock = Ember.Object.extend({
        second: null,
        minute: null,
        hour:   null,

        init: function() {
          this.tick();
        },

        tick: function() {
          var now = new Date()

          this.setProperties({
            second: now.getSeconds(),
            minute: now.getMinutes(),
            hour:   now.getHours()
          });

          Em.run.later(this, this.tick, 1000);
        }
      });
      App.clock = App.Clock.create();

      App.Router.map(function() {
        this.resource('submissions.stream', {path: '/new'}, function() {
          this.route('custom', {path: ':args'});
        });
        this.resource('comments', function() {
          this.route('tree', {path: '/tree/:comment_id'});
        });
        this.resource('reddit', {path: '/*reddit_path'});
      });

      App.Router.reopen({
        location: 'history'
      });

      App.IndexRoute = Ember.Route.extend({
        redirect: function() {
          this.transitionTo('reddit', 'r/all');
        }
      });

      App.SubmissionsStreamIndexRoute = Ember.Route.extend({
        redirect: function() {
          this.transitionTo('submissions.stream.custom', '');
        }
      });

      App.CommentsTreeRoute = Ember.Route.extend({
        model: function(params) {
          var promise = Ember.Deferred.create(),
              url = "http://api-dev.redditanalytics.com/comment_tree?id=";
          $.ajax({
            url: url + params.comment_id
          }).then(function(response) {
            promise.resolve(response);
          }, function(error) {promise.reject(error);});
          return promise;
        },
        serialize: function(model) {
          return {
            comment_id: model.id
          };
        }
      });

      App.RedditRoute = Ember.Route.extend({
        model: function(params) {
          var promise = Ember.Deferred.create(),
              url = "http://reddit.com/",
              redditPath = params.reddit_path,
              parts = redditPath.split('?', 2),
              redditPathJson;
          if (parts.length > 1) {
            redditPathJson = parts[0] + '.json?' + parts[1] + '&jsonp=?';
          } else {
            redditPathJson = redditPath + '.json?jsonp=?';
          }

          $.ajax({
            url: url + redditPathJson,
            dataType: 'jsonp'
          }).then(function(response) {
            response.redditPath = redditPath;
            promise.resolve(response);
          }, function(error) {promise.reject(error);});
          return promise;
        },
        serialize: function(model) {
          return {
            reddit_path: model
          };
        }
      });

      App.SubmissionsStreamCustomRoute = Ember.Route.extend({
        model: function(params) {
          return params.args || '';
        },
        serialize: function(model) {
          return {args: model || ''};
        },

        setupController: function(controller, model) {
          var submissionsStream = this.controllerFor('submissions.stream');
          submissionsStream.set('args', model);
        }
      });

      App.SubmissionsStreamController = Ember.Controller.extend({
        args: null,

        newArgs: function() {
          return this.get('args') || '';
        }.property('args'),

        submissions: function() {
          return Em.A();
        }.property('args'),

        eventSource: function() {
          var args = this.get('args'),
              submissions = this.get('submissions');

          if (args != null) {
            var url = 'http://api-dev.redditanalytics.com/submission_stream?eventsource=true&' + args;
                eventSource = new EventSource(url);

            eventSource.onmessage = function(evt) {
              var post = JSON.parse(evt.data);
              submissions.insertAt(0, post);
            };
            return eventSource;
          }
        }.property('args'),

        eventSourceWillChange: function() {
          var es = this.get('eventSource');
          if (es && es.disconnect) {
            es.disconnect()
          }
        }.observesBefore('eventSource'),

        argsDidChange: function() {
          this.get('eventSource');
        }.observes('args').on('init')
      });

      App.RedditItemMixin = Ember.Mixin.create({
        redditDomain: 'http://reddit.com',
        clock: App.clock,

        url: function() {
          var url = this.get('model.url'),
              parts = url.split('reddit.com/', 2);
          if (parts.length > 1) {
            return '/' + parts[1];
          }
          return url;
        }.property('model.url'),

        selfText: function() {
          var self_text = this.get('model.selftext_html');
          if (self_text) {
            return App.htmlDecode(self_text);
          }
        }.property('model.selftext_html'),

        body: function() {
          var body = this.get('model.body_html') || this.get('model.body');
          return App.htmlDecode(body) || '';
        }.property('model.body_html'),

        permalink: function() {
          var permalink = this.get('content.permalink');
          if (permalink) {return permalink;}
          var linkId = this.get('link_id'),
              id = this.get('id'),
              subreddit = this.get('subreddit');
          if (linkId && id && subreddit) {
            linkId = linkId.split('_', 2)[1];
            return '/r/' + subreddit + '/comments/' + linkId + '/_/' + id;
          }
        }.property('content.permalink', 'link_id', 'id', 'subreddit'),

        domainPath: function() {
          var domain = this.get('domain');
          if (domain) {
            if ('self.' === domain.substr(0, 5)) {
              return this.get('subredditPath');
            }
            return 'domain/' + domain;
          }
        }.property('domain'),

        permalinkPath: function() {
          var permalink = this.get('permalink');
          if (permalink) {
            return permalink.substr(1);
          }
        }.property('permalink'),

        authorPath: function() {
          return 'user/' + this.get('author');
        }.property('author'),

        subredditPath: function() {
          return 'r/' + this.get('subreddit');
        }.property('subreddit'),

        thumbnail: function() {
          var thumbnail = this.get('model.thumbnail');
          if (['self', 'default'].contains(thumbnail)) {
            return '/images/no_thumbnail.gif';
          } else if (thumbnail === 'nsfw') {
            return '/images/nsfw.gif';
          }
          return thumbnail;
        }.property('model.thumbnail'),

        score: function() {
          var score = this.get('model.score'),
              ups = this.get('ups') || 0,
              downs = this.get('downs') || 0;
          if (score) {
            return score;
          }
          return ups - downs;
        }.property('model.score', 'ups', 'downs'),

        children: function() {
          var children = this.get('model.children') || this.get('model.replies.data.children') || [];
          return children.map(function(child) {return child.data || child;});
        }.property('model'),

        childComments: function() {
          return this.get('children').filterProperty('created');
        }.property('children'),

        moreComments: function() {
          return this.get('children').filterProperty('count');
        }.property('children'),

        created: function() {
          return moment.utc(this.get('model.created_utc') * 1000).fromNow();
        }.property('model.created_utc', 'clock.minute')
      });

      App.SubmissionItemController = Ember.ObjectController.extend(App.RedditItemMixin);

      App.CommentsTreeController = Ember.ObjectController.extend(App.RedditItemMixin);

      App.RedditController = Ember.Controller.extend({
        listings: function() {
          var model = this.get('model');
          if (Em.isArray(model)) {
            return model.filterProperty('kind', 'Listing');
          } else if (model.kind  && model.kind === 'Listing') {
            return [model];
          }
          return [];
        }.property('model'),

        listingsChildren: function() {
          var children = [];
          this.get('listings').forEach(function(listing) {
            if (Em.isArray(listing.data.children)) {
              children.addObjects(listing.data.children);
            }
          })
          return children;
        }.property('listings'),

        posts: function() {
          return this.get('listingsChildren').filterProperty('kind', 't3').map(function(item) {return item.data});
        }.property('listingsChildren'),

        subreddits: function() {
          return this.get('posts').getEach('subreddit').uniq();
        }.property('posts'),

        sidebar: function() {
          var subreddits = this.get('subreddits'),
              sidebar = Em.Object.create();
          if (subreddits.get('length') === 1) {
            $.ajax({
              url: 'http://reddit.com/r/' + subreddits.get('firstObject') + '/about.json?jsonp=?',
              dataType: 'jsonp'
            }).then(function(response) {
              sidebar.set('subredditPath', 'r/' + subreddits.get('firstObject'));
              sidebar.setProperties(response.data);
            });
            return sidebar;
          }
        }.property('subreddits'),

        sidebarHtml: function() {
          var html = this.get('sidebar.description_html');
          if (html) { return App.htmlDecode(html); }
        }.property('sidebar.description_html'),

        comments: function() {
          var comments = this.get('listingsChildren').filterProperty('kind', 't1').map(function(item) {return item.data});
          return comments;
        }.property('listingsChildren'),

        hasMultiplePosts: function() {
          return this.get('posts.length') > 1;
        }.property('posts'),

        lastPostId: Em.computed.alias('posts.lastObject.id'),
        firstPostId: Em.computed.alias('posts.firstObject.id'),

        nextPath: function() {
          var hasMultiplePosts = this.get('hasMultiplePosts'),
              lastPostId = this.get('lastPostId'),
              path = this.get('model.redditPath'),
              parts = path.split('?', 2);
          if (hasMultiplePosts && lastPostId) {
            if (parts.length > 1) {
              path = path.replace(/(before=)[^\&]+/, '');
              return path.replace(/(after=)[^\&]+/, '$1' + 't3_' + lastPostId);
            } else {
              return this.get('model.redditPath') + '?after=t3_' + lastPostId;
            }
          }
        }.property('hasMultiplePosts', 'lastPostId'),

        prevPath: function() {
          var hasMultiplePosts = this.get('hasMultiplePosts'),
              firstPostId = this.get('firstPostId'),
              path = this.get('model.redditPath'),
              parts = path.split('?', 2);
          if (hasMultiplePosts && firstPostId) {
            if (parts.length > 1) {
              path = path.replace(/(after=)[^\&]+/, '');
              return path.replace(/(before=)[^\&]+/, '$1' + 't3_' + firstPostId);
            } else {
              return this.get('model.redditPath') + '?before=t3_' + firstPostId;
            }
          }
        }.property('hasMultiplePosts', 'firstPostId')
      });

      App.LoadingController = Em.Controller.extend({
        messages: [
          'Frying bacon...',
          'Narwal spotting...',
          'Taking arrow to the knee...',
          "GGG Webpage: Tells you when it's loading...",
          'YUNO render yet?',
          'I heard you like loading screens; so I [loading]',
          'Whoring karma...',
          'Reposting cats pictures...',
          'Reticulating splines...',
          'Generating puns...',
          'Hunting witches...',
          'Downvoting memes...',
          'Realigning the Heisenberg compensator...',
          'Adjusting the matter/antimatter ratio...',
          'Rotating deflector frequencies...',
          'Reversing polarity...',
          'Adjusting field intermix ratio...',
          'Tuning phase discriminator...',
          'Synchronizing positronic network...',
          'Constructing a sufficiently robust spiral decommutator...',
          'Initiating inverse tachyon beam...'
        ],
        loadingMessage: function() {
          var messages = this.get('messages');
          return messages[Math.floor(Math.random() * messages.length)];
        }.property().volatile()
      });

      App.RedditView = Em.View.extend({
        scrollToTop: function() {
          window.scrollTo(0, 0);
        }.observes('controller.model').on('didInsertElement')
      });
    </script>
  </body>
</html>
