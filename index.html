<html>
  <head>
    <title>rednit</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/0.4.10/themes/pace-theme-minimal.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/pace/0.4.10/pace.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">
    <style type='text/css'>
      html, body {
        height: 100%;
      }
      .navbar-inverse {
        background: url('/images/white-linen.jpg');
        box-shadow: 0px 5px 5px #888888;
        max-height: 50px;
        overflow: hidden;
      }
      .navbar-inverse .navbar-inner {
        background-image: linear-gradient(to bottom,rgba(141, 0, 0, 0.62) 0,rgba(184, 14, 14, 0.35) 100%);
      }
      #footer {
        /*
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        */
        clear: both;
        box-shadow: 0px -5px 5px #888888;
        margin-bottom: 0;
      }

      .navbar-inverse .navbar-nav>li>a,
      .navbar-inverse .navbar-brand {
        color: white;
      }

      @-webkit-keyframes pulse {
          0% {background-color: rgba(255, 255, 255, 0.1);}
          100% {background-color: rgba(255, 0, 0, 0.1);}
      }

      .loading {
        -webkit-animation: pulse 1s infinite alternate;
        text-align: center;
        padding-top: 3em;
        padding-bottom: 3em;
      }

      section.sidebar {
        margin-top: 0;
        margin-left: 1em;
        color: white;
        width: 300px;
        border-radius: 1em;
        background-image: none;
        background-color: rgba(77, 0, 9, 0.54);
        box-shadow: -5px 5px 5px #888888;
      }

      .sidebar p,
      .sidebar blockquote,
      .sidebar table {
        font-size: 100%;
        color: white;
      }

      .sidebar ul {
        padding-left: 1.2em;
      }

      .sidebar a {
        color: #DDD
      }

      .sidebar h1 {
        font-size: 140%;
      }
      .sidebar h2 {
        font-size: 130%;
      }
      .sidebar h3 {
        font-size: 120%;
      }
      .sidebar h4 {
        font-size: 110%;
      }
      .sidebar h5 {
        font-size: 105%;
      }
      .sidebar h6 {
        font-size: 100%;
      }

      .ups, .downs, .score {
        text-align: right;
        width: 4em;
      }
      .ups {
        color: green;
      }
      .downs {
        color: red;
      }
      .submission .score {
        font-weight: bold;
      }
      .ups:before {
        content: '+';
      }
      .downs:before {
        content: '-';
      }
      .submission-list > .submission {
        padding: 1em;
        margin: 0 0 0 0;
      }
      .well,
      .nav-tabs,
      .submission-list > .submission:nth-child(even) {
        background-image: none;
        background-color: #EEEEEE;
        background-color: rgba(200, 200, 200, 0.3);
      }
      body {
        background: url('/images/white-linen.jpg');
      }
      .veronica {
        background-color: rgba(255, 255, 255, 0.5);
      }
      article.main {
        padding-top: 60px;
        padding-bottom: 60px;
      }

      /*
      article.container,
      .navbar .container {
        width: 100%;
      }
      */

      ul.comments {
        list-style-type: none;
        padding-left: 1em;
      }

      ul.comments li.comment {
        border-left: 1px solid #eeeeee;
        padding-left: 1em;
      }

      .comment .meta,
      .comment .body,
      .comment .buttons {
      }
      .comment .buttons {
        margin-top: -0.5em;
        padding-bottom: 1em;
      }

      .comment .body {
        max-width: 60em;
        overflow: auto;
      }

      .submission .domain,
      .comment .meta {
        color: #666;
      }

      .comment .meta a {
        font-weight: bold;
      }

      a {
        color: #369;
        color: #8D0000;
      }

      .submission .media-heading {
        font-size: 120%;
      }

      .stickied .media-heading a {
        font-weight: bold;
        color: green;
      }

      .comment .buttons a {
        color: #666;
        font-weight: bold;
        margin-top: 0;
        padding-top: 1em;
        margin-right: 0.5em;
      }

      .has-multiple-posts .selftext {
        display: none;
      }
      .submission-image img {
        max-width: 100%;
        max-height: 800px;
      }
    </style>
  </head>
  <body>
    <script type="text/x-handlebars">
      <div class='navbar navbar-inverse navbar-fixed-top'>
        <div class='navbar-inner'>
            {{#linkTo "about" class="navbar-brand"}}rednit{{/linkTo}}
            <div class='navbar-collapse collapse'>
              <ul class='nav navbar-nav'>
                {{#linkTo "reddit" "r/all" tagName="li"}}
                  <a href='/r/all' class='dummy'>/r/all</a>
                {{/linkTo}}
                {{#linkTo "submissions.stream" tagName="li"}}
                  <a href='/new' class='dummy'>/new</a>
                {{/linkTo}}
                {{#linkTo "comments.search" tagName="li"}}
                  <a href='/comments/search' class='dummy'>/comments/search</a>
                {{/linkTo}}
              </ul>
              <ul class='nav navbar-nav navbar-right'>
                {{#each headerSubreddits}}
                  {{#linkTo "reddit" this tagName="li"}}
                    <a href='/{{unbound this}}' class='dummy'>{{unbound this}}</a>
                  {{/linkTo}}
                {{/each}}
              </ul>
            </div>
        </div>
      </div>
      <article class='main'>{{outlet}}</article>
      <div id="footer" class="navbar navbar-inverse">
        <div class='navbar-inner'>
          <div class='navbar-collapse collapse'>
            <ul class='nav navbar-nav navbar-left'>
              <li>
                <a href='http://reddit.com' class='dummy'>Powered by reddit.com</a>
              </li>
            </ul>
            <ul class='nav navbar-nav navbar-right'>
              {{#linkTo "about" class='veronica-version' tagName="li"}}
                <a href='/about' class='dummy'>Veronica <span>v0.0.1 WIP</span></a>
              {{/linkTo}}
            </ul>
          </div>
        </div>
      </div>
    </div>
    </script>
    <script type="text/x-handlebars" data-template-name="about">
      <article class='about container'>
        <h2>About rednit</h2>
        <div class='well'>
          <p>rednit is a project created by redditors to provide software tools and services that improve the reddit experience</p>
          <p>Formerly known as {{#linkTo 'reddit' 'r/redditanalytics'}}Reddit Analytics{{/linkTo}}, rednit focuses on providing search and streaming APIs in addition to those already provided by reddit.</p>
        </div>

        <h3>Who?</h3>
        <div class='well'>
          <h4>{{#linkTo 'reddit' 'user/Stuck_In_the_Matrix'}}/u/Stuck_In_the_Matrix{{/linkTo}}</h4>
          <h4>{{#linkTo 'reddit' 'user/AnkhMorporkian'}}/u/AnkhMorporkian{{/linkTo}}</h4>
          <h4>{{#linkTo 'reddit' 'user/go1dfish'}}/u/go1dfish{{/linkTo}}</h4>
        </div>

        <h3>What?</h3>
        <div class='well'>
          <h4>Comment &amp; Submission Search API</h4>
          <p>rednit's comment search API provides the previously unheard of ability to search comments on reddit.
        </div><div class='well'>
          <h4>Comment &amp; Submission Stream API</h4>
          <p>Does your bot need to see posts or comments on reddit as they happen?  Don't want to poll?  Our streams are just what you need.</p>
        </div><div class='well'>
          <h4>Veronica Reddit Client</h4>
          <p>Veronica is the web application powering what you see here.</p>
          <p>Combining reddit's native API's with our own search and stream APIs, Veronica is able to provide a reddit browsing experience second to none.</p>
          <p>Veronica is an open-source <a href='http://emberjs.com' target='ember'>Ember.js</a> application and is <a href='http://github.com/AnkhMorporkian/RedditAnalytics-frontend' target='github'>available on github</a>, or simply <em>view source</em> in your browser</p>
        </div>
      </article>
    </script>
    <script type="text/x-handlebars" data-template-name="submissions/stream">
      <div class="input-group">
        <span class="input-group-addon">http://api.rednit.com/submission_stream?</span>
        {{input class="form-control" value=newArgs placeholder="Stream URL arguments" size="128"}}
        {{#linkTo "submissions.stream.custom" newArgs class='input-group-addon'}}
          Change Stream
        {{/linkTo}}
      </div>
      <div class='submission-list'>
      {{#each submissions itemController="redditItem"}}
        {{partial "submissionItem"}}
      {{else}}
        <div class='waiting media'>
          <div class='media-body'>
            <h1 class='loading'>
              {{{loadingMessage}}}
            </h1>
          </div>
        </div>
      {{/each}}
      </div>
    </script>
    <script type="text/x-handlebars" data-template-name="submissionItem">
      <div {{bind-attr class='stickied :submission :media'}}>
          <div class='pull-left votes'>
            <div class='ups'>{{unbound ups}}</div>
            <div class='score'>{{unbound score}}</div>
            <div class='downs'>{{unbound downs}}</div>
          </div>
        {{#if thumbnail}}
          <div class='pull-left'>
            <a href="{{unbound linkUrl}}" target="reddit">
              <img class='media-object' src="{{unbound thumbnail}}"/>
            </a>
          </div>
        {{/if}}
        <div class='media-body'>
          <span class='media-heading'>
            <a href="{{unbound linkUrl}}" target="reddit">{{{unbound title}}}</a>
          </span>
          {{#linkTo 'reddit' domainPath class='domain'}}({{unbound domain}}){{/linkTo}}
          {{#if link_flair_text}}
            <span class='label label-primary link-flair'>{{unbound link_flair_text}}</span>
          {{/if}}
          <div class='media'>
            {{#if selfText}}
              <section class='well selftext'>
                {{{unbound selfText}}}
              </section>
            {{/if}}
            {{#if imageUrl}}
              {{#unless parentController.hasMultiplePosts}}
                {{#if over_18}}
                  {{#if parentController.isSinglePost}}
                    <section class='well submission-image'>
                      <img src='{{unbound imageUrl}}' alt='{{unbound url}}'/>
                    </section>
                  {{/if}}
                {{else}}
                  <section class='well submission-image'>
                    <img src='{{unbound imageUrl}}' alt='{{unbound url}}'/>
                  </section>
                {{/if}}
              {{/unless}}
            {{/if}}
            {{#if youtubeId}}
              {{#if parentController.isSinglePost}}
              <section class='well submission-video'>
                <iframe class="youtube-player" type="text/html" width="640" height="385" src="http://www.youtube.com/embed/{{unbound youtubeId}}" allowfullscreen frameborder="0">
</iframe>
              </section>
              {{/if}}
            {{/if}}
            {{#if over_18}}
              <span class="label label-danger nsfw">NSFW</span>
            {{/if}}
            {{#linkTo 'reddit' permalinkPath class="permalink"}}
              {{#if num_comments}}
                {{unbound num_comments}}
              {{/if}}
              comments
            {{/linkTo}}
            submitted
            <span class='date'>{{created}}</span>
            by
            {{#linkTo 'reddit' authorPath class="author"}}
              {{unbound author}}
              {{#if author_flair_text}}
                <span class='label label-info link-flair'>{{unbound author_flair_text}}</span>
              {{/if}}
            {{/linkTo}}
            to {{#linkTo 'reddit' subredditPath class="subreddit"}}{{unbound subreddit}}{{/linkTo}}
          </div>
        </div>
      </div>
    </script>

    <script type="text/x-handlebars" data-template-name="commentsItem">
      <li class='comment'>
        {{#unless isSinglePost}}
          <a class="link-title" href="{{unbound permalink}}">{{unbound link_title}}</a>
          {{#if link_author}}
          by <a class="link-author" href="/user/{{unbound link_author}}">{{unbound link_author}}</a>
          {{/if}}
          in <a class="subreddit" href="/r/{{unbound subreddit}}">{{unbound subreddit}}</a>
        {{/unless}}
        <div class='meta'>
          by
          <a href='/user/{{unbound author}}' class='author'>
            {{unbound author}}
            {{#if author_flair_text}}
              <span class='label label-info link-flair'>{{unbound author_flair_text}}</span>
            {{/if}}
          </a>
          {{#if score_hidden}}
            <span class='score-hidden'>[score hidden]</span>
          {{else}}
            <span class='score'>{{unbound score}} points</span>
          {{/if}}
          <span class='date'>{{unbound created}}</span>
          {{#if gilded}}
            <span class='gilded glyphicon glyphicon-star-empty label label-warning'>{{unbound gilded}}</span>
          {{/if}}
        </div>
        <section class='body'>{{{unbound body}}}</section><div class='buttons'>
          <a href='{{unbound permalink}}' class='permalink'>permalink</a>
          {{#linkTo 'comments.tree' id class='comment-tree-search'}}search{{/linkTo}}
        </div>
        <ul class='comments'>
        {{#each childComments itemController="redditItem"}}
          {{partial "commentsItem"}}
        {{/each}}
        {{#each moreComments}}
          <li class='more'>and {{unbound count}} replies </li>
        {{/each}}
        </ul>
      </li>
    </script>

    <script type="text/x-handlebars" data-template-name="comments/tree">
      <h2>Comment Search Results</h2>
      <ul class='comments'>
        {{partial "commentsItem"}}
      </ul>
    </script>

    <script type="text/x-handlebars" data-template-name="comments/search/query">
      <div class="input-group">
        <span class="input-group-addon">http://api.rednit.com/search_comments?</span>
        {{input class="form-control" value=newQuery placeholder="Search URL arguments" size="128"}}
        {{#linkTo "comments.search.query" newQuery class='input-group-addon'}}
          New Search
        {{/linkTo}}
      </div>
      <ul class='comments'>
        {{#each results itemController="redditItem"}}
          {{partial "commentsItem"}}
        {{/each}}
      </ul>
    </script>

    <script type="text/x-handlebars" data-template-name="reddit">
      <section {{bindAttr class='hasMultiplePosts :reddit'}}>
        {{#if sidebar.subredditPath}}
          <ul class='nav nav-tabs'>
            <li><a href='/{{unbound sidebar.subredditPath}}/'>Hot</a></li>
            <li><a href='/{{unbound sidebar.subredditPath}}/new'>New</a></li>
            <li><a href='/{{unbound sidebar.subredditPath}}/rising'>Rising</a></li>
            <li><a href='/{{unbound sidebar.subredditPath}}/controversial'>Controversial</a></li>
            <li><a href='/{{unbound sidebar.subredditPath}}/top'>Top</a></li>
            <li><a href='/{{unbound sidebar.subredditPath}}/comments'>Comments</a></li>
            <li><a href='/{{unbound sidebar.subredditPath}}/gilded'>Gilded</a></li>
          </ul>
          <section class='sidebar well pull-right'>
            <h1 class='subreddit-title'>
              {{#linkTo 'reddit' sidebar.subredditPath}}/r/{{sidebar.display_name}}{{/linkTo}}
            </h1>
            <span class='subscribers'>
              <span class='number'>{{sidebar.subscribers}}</span>
              <span class='word'>readers</span>
            </span>
            <p class='users-online' title="logged-in users viewing this subreddit in the past 15 minutes">
              <span class='number'>{{sidebar.accounts_active}}</span>
              <span class='word'>users here now</span>
            </p>
            {{{sidebarHtml}}}
          </section>
        {{else}}
          {{#if user.data}}
            {{#with user.data}}
            <section class='sidebar user well pull-right'>
              <h1>{{name}}</h1>
              <span class='karma'>{{link_karma}}</span> link karma<br/>
              <span class='karma comment-karma'>{{comment_karma}}</span> comment karma
            </section>
            {{/with}}
          {{/if}}
        {{/if}}
        <div class='submission-list'>
        {{#each items itemController="redditItem"}}
          {{#if body}}
            <ul class='comments'>
            {{partial "commentsItem"}}
            </ul>
          {{else}}
            {{partial "submissionItem"}}
          {{/if}}
        {{/each}}
        </div>

        <div class='page-nav'>
          {{#if hasMultiplePosts}}
            view more:
            {{#if prevPath}}
              {{#linkTo 'reddit' prevPath class='label label-default'}}&laquo; prev{{/linkTo}}
            {{/if}}
            {{#if nextPath}}
              {{#linkTo 'reddit' nextPath class='label label-default'}}next &raquo;{{/linkTo}}
            {{/if}}
            {{!--
            or try a {{#linkTo 'reddit' 'r/random' class='label label-default'}}random subreddit{{/linkTo}}
            --}}
          {{/if}}
        </div>
      </section>
    </script>

    <script type="text/x-handlebars" data-template-name="login">
      <fieldset>
        <label>
          Username
          {{input type="text" value=username}}
        </label><label>
          Password
          {{input type="password" value=password}}
        </label>
        <input type='submit' value='Login' {{action login}}/>
      </fieldset>
    </script>

    <script type="text/x-handlebars" data-template-name="loading">
      <h1 class='loading'>{{{loadingMessage}}}</h1>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.4.0/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ember.js/1.2.0-beta.4/ember.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/URI.js/1.7.2/URI.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/pagedown/1.0/Markdown.Converter.min.js"></script>
    <script type="text/javascript">
      var Veronica = Ember.Application.create();

      Veronica.htmlDecode = function(value){
        return $('<div/>').html(value).text();
      };

      Veronica.roxyPath = '/roxy';

      Ember.Handlebars.registerHelper('html', function(html) {
        return new Handlebars.SafeString(html);
      });

      Veronica.shuffle = function(v){
        for(var j, x, i = v.length; i; j = parseInt(Math.random() * i), x = v[--i], v[i] = v[j], v[j] = x);
        return v;
      };

      Veronica.Clock = Ember.Object.extend({
        second: null,
        minute: null,
        hour:   null,

        init: function() {
          this.tick();
        },

        tick: function() {
          var now = new Date()

          this.setProperties({
            second: now.getSeconds(),
            minute: now.getMinutes(),
            hour:   now.getHours()
          });

          Em.run.later(this, this.tick, 1000);
        }
      });
      Veronica.clock = Veronica.Clock.create();

      Veronica.Router.map(function() {
        this.resource('submissions.stream', {path: '/new'}, function() {
          this.route('custom', {path: ':args'});
        });
        this.resource('comments', function() {
          this.route('tree', {path: '/tree/:comment_id'});
          this.resource('comments.search', {path: '/search'}, function() {
            this.route('query', {path: '/*query'});
          });
        });
        this.resource('about');
        this.resource('reddit', {path: '/*reddit_path'});
        this.resource('login');
      });

      Veronica.Router.reopen({
        location: 'history'
      });

      Veronica.IndexRoute = Ember.Route.extend({
        redirect: function() {
          this.transitionTo('reddit', 'r/all');
        }
      });

      Veronica.SubmissionsStreamIndexRoute = Ember.Route.extend({
        redirect: function() {
          this.transitionTo('submissions.stream.custom', '');
        }
      });

      Veronica.CommentsTreeRoute = Ember.Route.extend({
        model: function(params) {
          var url = "http://api.rednit.com/comment_tree?id=";
          return $.ajax({url: url + params.comment_id});
        },
        serialize: function(model) {
          return {
            comment_id: model.id
          };
        }
      });

      Veronica.CommentsSearchIndexRoute = Ember.Route.extend({
        redirect: function() {
          this.transitionTo('comments.search.query', '');
        }
      });

      Veronica.CommentsSearchQueryRoute = Ember.Route.extend({
        model: function(params) {
          return $.ajax({url: 'http://api.rednit.com/search_comments?' + params.query}).then(function(response) {
            response.query = params.query;
            return response;
          });;
        },
        serialize: function(model) {
          if (typeof model === 'string') {
            return {query: model};
          }
          return model.query;
        }
      });

      Veronica.RedditRoute = Ember.Route.extend({
        model: function(params) {
          var url = "http://reddit.com/",
              redditPath = params.reddit_path,
              parts = redditPath.split('?', 2),
              redditPathJson;
          if (parts.length > 1) {
            redditPathJson = parts[0] + '.json?' + parts[1] + '&jsonp=?';
          } else {
            redditPathJson = redditPath + '.json?jsonp=?';
          }

          return Ember.RSVP.resolve($.ajax({
            url: url + redditPathJson,
            dataType: 'jsonp'
          }).then(function(response) {
            response.redditPath = redditPath;
            return response;
          }));
        },
        serialize: function(model) {
          return {
            reddit_path: model
          };
        }
      });

      Veronica.SubmissionsStreamCustomRoute = Ember.Route.extend({
        model: function(params) {
          return params.args || '';
        },
        serialize: function(model) {
          return {args: model || ''};
        },

        setupController: function(controller, model) {
          var submissionsStream = this.controllerFor('submissions.stream');
          submissionsStream.set('args', model);
        }
      });

      Veronica.ApplicationRoute = Em.Route.extend({
        actions: {
          login: function() {
            this.controllerFor('login').login();
          }
        }
      });

      Veronica.SubmissionsStreamController = Ember.Controller.extend({
        needs: 'application'.w(),
        loadingMessage: Em.computed.alias('controllers.application.loadingMessage'),

        args: null,

        newArgs: function() {
          return this.get('args') || '';
        }.property('args'),

        submissions: function() {
          return Em.A();
        }.property('args'),

        eventSource: function() {
          var args = this.get('args'),
              submissions = this.get('submissions');

          if (args != null) {
            var url = 'http://api.rednit.com/submission_stream?eventsource=true&' + args;
                eventSource = new EventSource(url);

            eventSource.onmessage = function(evt) {
              var post = JSON.parse(evt.data);
              submissions.insertAt(0, post);
              while (submissions.get('length') > 100) {
                submissions.popObject();
              }
            };
            return eventSource;
          }
        }.property('args'),

        eventSourceWillChange: function() {
          var es = this.get('eventSource');
          if (es && es.disconnect) {
            es.disconnect()
          }
        }.observesBefore('eventSource'),

        argsDidChange: function() {
          this.get('eventSource');
        }.observes('args').on('init')
      });

      Veronica.RedditItemMixin = Ember.Mixin.create({
        needs: 'application'.w(),
        subreddits: Em.computed.alias('controllers.application.subreddits'),

        redditDomain: 'http://reddit.com',
        clock: Veronica.clock,

        isSinglePost: Em.computed.alias('parentController.isSinglePost'),

        subredditDidChange: function() {
          var subreddit = this.get('subreddit');
          if (subreddit) {
            this.get('subreddits').addObject('r/' + subreddit);
          }
        }.observes('subreddit').on('init'),

        url: function() {
          var url = this.get('model.url');
          if (!url) {return;}
          var parts = url.split('reddit.com/', 2);
          if (parts.length > 1) {
            return '/' + parts[1];
          }
          return url;
        }.property('model.url'),

        linkUrl: function() {
          var url = this.get('url'),
              permalink = this.get('permalink'),
              imageUrl = this.get('imageUrl'),
              youtubeId = this.get('youtubeId');
          if (imageUrl || youtubeId) {
            return permalink;
          }
          return url;
        }.property('url', 'imageUrl', 'youtubeId', 'permalink'),

        imageUrl: function() {
          var url = this.get('url'),
              domain = this.get('domain');
          if (!url) { return;}
          var ext = '',
              parts = url.split('.');
          if (parts.length) {
            ext = parts[parts.length - 1];
            if (ext) {ext = ext.toLowerCase()}
          }
          if (['jpeg', 'jpg', 'png', 'gif'].contains(ext)) {
            return url;
          }
          if (['imgur.com', 'i.imgur.com'].contains(this.get('domain'))) {
            return url + '.jpg';
          }
        }.property('url'),

        youtubeId: function() {
          var url = this.get('url'),
              domain = this.get('domain');
          if (['youtube.com'].contains(domain)) {
            return URI(url).query(true).v;
          }
        }.property('url'),

        selfText: function() {
          var self_text = this.get('model.selftext_html');
          if (self_text) {
            return Veronica.htmlDecode(self_text);
          }
        }.property('model.selftext_html'),

        body: function() {
          var body = this.get('model.body_html');
          if (!body) {
            body = this.get('model.body');
            if (body) {
              var converter = new Markdown.Converter();
              return converter.makeHtml(body);
            }
          }
          return Veronica.htmlDecode(body) || '';
        }.property('model.body_html'),

        permalink: function() {
          var permalink = this.get('content.permalink'),
              parts = [];
          if (permalink) {
            parts = permalink.split('reddit.com/', 2);
            if (parts.length > 1) {
              permalink = '/' + parts[1];
            }
          }
          if (permalink) {return permalink;}
          var linkId = this.get('link_id'),
              id = this.get('id'),
              subreddit = this.get('subreddit');
          if (linkId && id && subreddit) {
            linkId = linkId.split('_', 2)[1];
            return '/r/' + subreddit + '/comments/' + linkId + '/_/' + id;
          }
        }.property('content.permalink', 'link_id', 'id', 'subreddit'),

        domainPath: function() {
          var domain = this.get('domain');
          if (domain) {
            if ('self.' === domain.substr(0, 5)) {
              return this.get('subredditPath');
            }
            return 'domain/' + domain;
          }
        }.property('domain'),

        permalinkPath: function() {
          var permalink = this.get('permalink');
          if (permalink) {
            return permalink.substr(1);
          }
        }.property('permalink'),

        authorPath: function() {
          return 'user/' + this.get('author');
        }.property('author'),

        subredditPath: function() {
          return 'r/' + this.get('subreddit');
        }.property('subreddit'),

        thumbnail: function() {
          var thumbnail = this.get('model.thumbnail');
          if (['self', 'default'].contains(thumbnail)) {
            return '/images/no_thumbnail.gif';
          } else if (thumbnail === 'nsfw') {
            return '/images/nsfw.gif';
          }
          return thumbnail;
        }.property('model.thumbnail'),

        score: function() {
          var score = this.get('model.score'),
              ups = this.get('ups') || 0,
              downs = this.get('downs') || 0;
          if (score) {
            return score;
          }
          return ups - downs;
        }.property('model.score', 'ups', 'downs'),

        children: function() {
          var children = this.get('model.children') || this.get('model.replies.data.children') || [];
          return children.map(function(child) {return child.data || child;});
        }.property('model'),

        childComments: function() {
          return this.get('children').filterProperty('created_utc');
        }.property('children'),

        moreComments: function() {
          return this.get('children').filterProperty('count');
        }.property('children'),

        created: function() {
          return moment.utc(this.get('model.created_utc') * 1000).fromNow();
        }.property('model.created_utc', 'clock.minute')
      });

      Veronica.RedditItemController = Ember.ObjectController.extend(Veronica.RedditItemMixin);

      Veronica.CommentsTreeController = Veronica.RedditItemController.extend();;

      Veronica.CommentsSearchQueryController = Ember.ObjectController.extend({
        newQuery: function(key, value) {
          if (arguments.length > 1) {
            return value;
          }
          return this.get('query') || '';
        }.property('query')
      });

      Veronica.RedditController = Ember.Controller.extend({
        listings: function() {
          var model = this.get('model');
          if (Em.isArray(model)) {
            return model.filterProperty('kind', 'Listing');
          } else if (model.kind  && model.kind === 'Listing') {
            return [model];
          }
          return [];
        }.property('model'),

        listingsChildren: function() {
          var children = [];
          this.get('listings').forEach(function(listing) {
            if (Em.isArray(listing.data.children)) {
              children.addObjects(listing.data.children);
            }
          })
          return children;
        }.property('listings'),

        items: function() {
          return this.get('listingsChildren').getEach('data');
        }.property('listingsChildren'),

        posts: function() {
          return this.get('listingsChildren').filterProperty('kind', 't3').map(function(item) {return item.data});
        }.property('listingsChildren'),

        subreddits: function() {
          var postSubs = this.get('posts').getEach('subreddit');
          return postSubs.concat(this.get('comments').getEach('subreddit')).uniq();
        }.property('posts'),

        users: function() {
          var postSubs = this.get('posts').getEach('author');
          return postSubs.concat(this.get('comments').getEach('author')).uniq();
        }.property('posts'),

        sidebar: function() {
          var subreddits = this.get('subreddits'),
              sidebar = Em.Object.create();
          if (subreddits.get('length') === 1) {
            $.ajax({
              url: 'http://reddit.com/r/' + subreddits.get('firstObject') + '/about.json?jsonp=?',
              dataType: 'jsonp'
            }).then(function(response) {
              sidebar.set('subredditPath', 'r/' + subreddits.get('firstObject'));
              sidebar.setProperties(response.data);
            });
            return sidebar;
          }
        }.property('subreddits'),

        user: function() {
          var users = this.get('users'),
              user = Em.Object.create();
          if (this.get('isSingleUser')) {
            $.ajax({
              url: 'http://reddit.com/user/' + users.get('firstObject') + '/about.json?jsonp=?',
              dataType: 'jsonp'
            }).then(function(response) {
              user.set('userPath', 'user/' + users.get('firstObject'));
              user.setProperties(response);
            });
            return user;
          }
        }.property('users'),

        sidebarHtml: function() {
          var html = this.get('sidebar.description_html');
          if (html) { return Veronica.htmlDecode(html); }
        }.property('sidebar.description_html'),

        comments: function() {
          var comments = this.get('listingsChildren').filterProperty('kind', 't1').map(function(item) {return item.data});
          return comments;
        }.property('listingsChildren'),

        hasMultiplePosts: function() {
          return this.get('posts.length') > 1;
        }.property('posts.length'),

        isSingleSubreddit: function() {
          return this.get('subreddits.length') === 1;
        }.property('subreddits.length'),

        isSinglePost: function() {
          return this.get('posts.length') === 1;
        }.property('posts.length'),

        isSingleUser: function() {
          return this.get('users.length') === 1;
        }.property('users.length'),

        lastPostId: Em.computed.alias('posts.lastObject.id'),
        firstPostId: Em.computed.alias('posts.firstObject.id'),

        nextPath: function() {
          var hasMultiplePosts = this.get('hasMultiplePosts'),
              lastPostId = this.get('lastPostId'),
              path = this.get('model.redditPath'),
              parts = path.split('?', 2);
          if (hasMultiplePosts && lastPostId) {
            if (parts.length > 1) {
              path = path.replace(/(before=)[^\&]+/, '');
              return path.replace(/(after=)[^\&]+/, '$1' + 't3_' + lastPostId);
            } else {
              return this.get('model.redditPath') + '?after=t3_' + lastPostId;
            }
          }
        }.property('hasMultiplePosts', 'lastPostId'),

        prevPath: function() {
          var hasMultiplePosts = this.get('hasMultiplePosts'),
              firstPostId = this.get('firstPostId'),
              path = this.get('model.redditPath'),
              parts = path.split('?', 2);
          if (hasMultiplePosts && firstPostId) {
            if (parts.length > 1) {
              path = path.replace(/(after=)[^\&]+/, '');
              return path.replace(/(before=)[^\&]+/, '$1' + 't3_' + firstPostId);
            } else {
              return this.get('model.redditPath') + '?before=t3_' + firstPostId;
            }
          }
        }.property('hasMultiplePosts', 'firstPostId')
      });

      Veronica.LoadingController = Em.Controller.extend({
        needs: 'application'.w(),
        loadingMessage: Em.computed.alias('controllers.application.loadingMessage')
      });

      Veronica.LoginController = Em.Controller.extend({
        needs: 'application'.w(),
        proxy: Em.computed.alias('controllers.application.proxy'),

        username: '',
        password: '',

        login: function() {
          var promise = Em.Deferred.create();
          $.ajax({
            url: 'http://roxy.rednit.com',
            data: {
              _request: {
                url:      'https://www.reddit.com/api/login',
                method:   'POST',
                headers: {
                  Authorization: 'OAuth 0123456789abcdef0123456789abcdef'
                },
              },
              user:     this.get('username'),
              passwd:   this.get('password')
            },
            dataType: 'jsonp'
          }).then(function(response) {
            debugger;
            console.log('got response', response);
            promise.resolve(response);
          });
          return promise;
        }
      });

      Veronica.ApplicationController = Em.Controller.extend({
        clock: Veronica.clock,
        proxy: '/roxy/',
        messages: [
          'Frying bacon',
          'Narwal spotting',
          'Taking arrow to the knee',
          "GGG Webpage: Tells you when it's loading",
          'YUNO render yet?',
          'Yo Dawg!<br>I heard you like loading screens<br>so I put a loading message in your loading message so you can load while you load:<br>[loading]',
          'Whoring karma',
          'Reposting cat pictures',
          'Reticulating splines',
          'Threading puns',
          'Hunting witches',
          'Downvoting memes',
          'Realigning the Heisenberg compensator',
          'Adjusting the matter/antimatter ratio',
          'Rotating deflector frequencies',
          'Reversing polarity',
          'Adjusting field intermix ratio',
          'Tuning phase discriminator',
          'Synchronizing positronic network',
          'Constructing a sufficiently robust spiral decommutator',
          'Initiating inverse tachyon beam',
          'Manning battle stations',
          'Feeding Mister Splashy Pants',
          'Abducting snoo',
          'Rick rolling',
          'Don\'t load me bro',
          'Test loading message, please ignore',
          'Ramparting threads',
          'Reading reddiquette',
          'Invoking godwin',
          'Starving trolls',
          'HA HA<br>I\'m using the reddits'
        ],

        loadingMessage: function() {
          var messages = this.get('messages');
          return messages[Math.floor(Math.random() * messages.length)] + '...';
        }.property().volatile(),

        changeLoadingMessage: function() {
          this.notifyPropertyChange('loadingMessage');
        }.observes('clock.second'),

        subreddits: function() {
          return Em.A();
        }.property(),

        headerSubreddits: function() {
          return Veronica.shuffle(this.get('subreddits')).slice(0, 5);
        }.property('subreddits.@each', 'clock.minute')
      });

      Veronica.RedditView = Em.View.extend({
        scrollToTop: function() {
          window.scrollTo(0, 0);
        }.observes('controller.model').on('didInsertElement')
      });
      Veronica.ApplicationView = Em.View.extend({
        classNames: 'veronica'.w()
      });

      window.onclick = function(e) {
        e = e || window.event;
        var t = e.target || e.srcElement
        t = $(t).closest('a').get(0);
        if (t && t.href && !$(t).hasClass('dummy') && !$(t).hasClass('ember-view')){
          var parts = t.href.split('reddit.com/', 2);
          if (parts.length <= 1) {
            parts = t.href.split('rednit.com/', 2);
          }
          if (parts.length > 1) {
            Veronica.Router.router.transitionTo('reddit', parts[1]);
            return false;
          }
        }
      };
    </script>
  </body>
</html>
